# webpacké«˜çº§

## ä¸€ã€source-map

### ä½œç”¨

- èƒ½å¤Ÿä»å·²è½¬æ¢çš„ä»£ç ï¼Œæ˜ å°„åˆ°åŸå§‹çš„æºæ–‡ä»¶
- ä½¿æµè§ˆå™¨èƒ½å¤Ÿé‡æ„åŸå§‹æºå¹¶åœ¨è°ƒè¯•å…¶ä¸­æ˜¾ç¤ºé‡å»ºçš„åŸå§‹æº

å¦‚ä½•ä½¿ç”¨source-map

1. é€šè¿‡webpacké…ç½®ç”Ÿæˆsource-map
2. åœ¨è½¬æ¢åçš„ä»£ç ï¼Œæœ€åæ·»åŠ ä¸€ä¸ªæ³¨é‡Šï¼ŒæŒ‡å‘source-map(ä¾‹å¦‚ï¼š`// sourceMappingURL=common.bundle.js.map`)

### webpacké…ç½®

https://webpack.docschina.org/configuration/devtool/#devtool

```jsx
module.exports = {
	mode: 'production',
	devtool: 'source-map'
}
```

ä¸ä¼šç”Ÿæˆsource-mapæ–‡ä»¶çš„é…ç½®

- false
- noneï¼ˆproductionæ¨¡å¼ä¸‹çš„é»˜è®¤å€¼ï¼‰
- evalï¼ˆdevelopmentæ¨¡å¼ä¸‹çš„é»˜è®¤å€¼ï¼‰

ä¸å¸¸è§çš„source-mapé…ç½®

- eval-source-map(ä¸ç”Ÿæˆsource-mapæ–‡ä»¶ï¼Œä»¥`DataURL`çš„å½¢å¼æ”¾åœ¨`eval`å‡½æ•°åé¢)
- inline-source-map(ä¸ç”Ÿæˆsource-mapæ–‡ä»¶ï¼Œä»¥`DataURL`çš„å½¢å¼æ”¾åœ¨æ‰“åŒ…æ–‡ä»¶çš„åé¢)
- cheap-source-map(æ›´åŠ é«˜æ•ˆï¼Œä¸ä¼šæ˜ å°„åˆ—ä¿¡æ¯ï¼Œé…ç½®åœ¨development)
- cheap-module-source-map(ç±»ä¼¼äº**cheap-source-mapï¼Œ**æºè‡ªloaderçš„source-mapå¤„ç†ä¼šæ›´å¥½ï¼Œé…ç½®åœ¨development)
- hidden-source-map(ä¼šç”Ÿæˆsource-mapæ–‡ä»¶ï¼Œä½†åˆ é™¤çš„å¯¹åº”çš„å¼•ç”¨æ³¨é‡Šï¼Œéœ€è¦æ‰‹åŠ¨åŠ `//# sourceMappingURL=bundle.js.map`)
- nosources-source-map(ç”Ÿæˆçš„source-mapæ–‡ä»¶åªæœ‰é”™è¯¯ä¿¡æ¯ï¼Œä¸ä¼šç”Ÿæˆæºä»£ç )

## äºŒã€babel

### ä¸ºä»€ä¹ˆéœ€è¦babelï¼Ÿ

éƒ¨åˆ†æµè§ˆå™¨å¯èƒ½ä¸è®¤è¯†ES6+çš„è¯­æ³•ï¼Œä»¥åŠä¸è®¤è¯†vueã€reactã€typescriptä»£ç ï¼Œå› æ­¤éœ€è¦babelå°†è¿™äº›ä»£ç è½¬æ¢ä¸ºæµè§ˆå™¨è®¤è¯†çš„æ™®é€šçš„JavaScriptã€‚

### babelå‘½ä»¤è¡Œä½¿ç”¨

1. å®‰è£…`@babel/core` 
2. å®‰è£…`@babel/cli`
3. å®‰è£…æ’ä»¶(`@babel/plugin-transform-block-scoping`ã€`@babel/plugin-transform-arrow-function`)
4. æ‰§è¡Œå‘½ä»¤

```bash
npm i @babel/core @babel/cli -D
npx babel ./src --out-dir ./dist --plugins=@babel/plugin-transform-block-scoping,@babel/plugin-transform-arrow-function
```

### babelé¢„è®¾

è§£å†³æ¯ä¸€æ¬¡è½¬æ¢éƒ½éœ€è¦å®‰è£…ä¸€ç§æ’ä»¶çš„é—®é¢˜

```bash
npm install @babel/preset-env -D
npx babel ./src --out-dir ./dist --presets=@babel/preset-env
```

### babelçš„åº•å±‚åŸç†

babelæ˜¯ä¸€ç§**ç¼–è¯‘å™¨**ï¼Œå°†ä¸€ç§**æºä»£ç **è½¬æ¢ä¸ºå¦ä¸€ç§**æºä»£ç **

babelçš„å·¥ä½œæµç¨‹

- è§£æé˜¶æ®µï¼ˆParsingï¼‰
- è½¬æ¢é˜¶æ®µï¼ˆTransformationï¼‰
- ç”Ÿæˆé˜¶æ®µï¼ˆCode Generationï¼‰

![babelå·¥ä½œæµç¨‹](https://image.aklry.com/docs/babel.png)

### babelçš„é…ç½®æ–‡ä»¶

- `babel.config.json|js|mjs|cjs`
- `.babelrc.json|js|mjs|cjs` æˆ–è€…`.babelrc`

```jsx
module.exports = {
	presets: [
		["@babel/preset-env"]
	]
}
```

## ä¸‰ã€browserslistå·¥å…·

**browserslist**æ˜¯ä¸€ä¸ªåœ¨**ä¸åŒçš„å‰ç«¯å·¥å…·**ä¹‹é—´ï¼Œ**å…±äº«ç›®æ ‡æµè§ˆå™¨**å’Œ**Node.js**ç‰ˆæœ¬çš„é…ç½®

### æµè§ˆå™¨æŸ¥è¯¢è¿‡ç¨‹

æˆ‘ä»¬ä¼šç¼–å†™ç±»ä¼¼äºä¸‹é¢çš„é…ç½®ï¼š

```bash
> 1%
last 2 version
not dead
```

é‚£ä¹ˆä¹‹åï¼Œè¿™äº›å·¥å…·å¦‚**babel**ç­‰å°±ä¼šæ ¹æ®æˆ‘ä»¬çš„é…ç½®æ¥è·å–ç›¸å…³çš„æµè§ˆå™¨ä¿¡æ¯ï¼Œä»¥æ–¹ä¾¿å†³å®šæ˜¯å¦éœ€è¦è¿›è¡Œå…¼å®¹æ€§çš„æ”¯æŒã€‚

### browserslistç¼–å†™

- è§„åˆ™ä¸€
    - defaults: é»˜è®¤æµè§ˆå™¨é…ç½®(**>0.5%,last 2 version,FireFox ESR, not dead**)
    - 5%:é€šè¿‡å…¨å±€ä½¿ç”¨æƒ…å†µç»Ÿè®¡ä¿¡æ¯é€‰æ‹©çš„æµè§ˆå™¨ç‰ˆæœ¬ï¼Œ**è¡¨ç¤ºå¸‚åœºå æœ‰ç‡**ã€‚å¯ä»¥ä½¿ç”¨â‰¥ã€<ã€å’Œâ‰¤ä¿®é¥°ã€‚
    - dead:è¡¨ç¤º**24ä¸ªæœˆ**å†…æ²¡æœ‰å®˜æ–¹æ”¯æŒæˆ–è€…æ›´æ–°çš„æµè§ˆå™¨ã€‚
    - last 2 version: è¡¨ç¤ºæ¯ä¸ªæµè§ˆå™¨çš„**æœ€åä¸¤ä¸ª**ç‰ˆæœ¬
- è§„åˆ™äºŒ
    - node 10:é€‰æ‹©æœ€æ–°çš„Node.js 10.x.x
    - ios7: ç›´æ¥ä½¿ç”¨iosæµè§ˆå™¨ç‰ˆæœ¬7
    - not ieâ‰¤8:æ’é™¤å…ˆå‰æŸ¥è¯¢é€‰æ‹©çš„æµè§ˆå™¨
    
    ### é…ç½®browserslist
    
    - æ–¹æ¡ˆä¸€ï¼šåœ¨package.jsonæ–‡ä»¶é…ç½®
    - æ–¹æ¡ˆäºŒï¼š.browserslistrcæ–‡ä»¶
    
    ```json
    {
    	"browserslist": [
    		"last 2 version",
    		"not dead",
    		">0.2%"
    	]
    }
    ```
    
    ```bash
    >1%
    not dead
    last 2 version
    ```
    

### babelé…ç½®è¦†ç›–browserslist

```jsx
module.exports = {
	module: {
		rules: [
			{
				test: /\.js$/,
				use: [
					{
						loader: 'babel-loader',
						options: {
							presets: [
								["@babel/preset-env", {
									targets: ">5%"
								}]
							]
						}
					}
				]
			}
		]
	}
}
```

<aside>
ğŸ’¡

åœ¨å¼€å‘ä¸­ä¸ä¼šä½¿ç”¨**targets**å±æ€§ï¼Œè€Œæ˜¯ä½¿ç”¨browserslistå·¥å…·ï¼Œå› ä¸ºbrowserslistå·¥å…·å¯ä»¥åœ¨å¤šä¸ªå·¥å…·é—´**å…±äº«æµè§ˆå™¨å…¼å®¹æ€§**é…ç½®

</aside>

## å››ã€polyfill

### ä¸ºä»€ä¹ˆä½¿ç”¨polyfill

ä½†æˆ‘ä»¬ç”¨åˆ°ä¸€äº›æ–°çš„è¯­æ³•ç‰¹æ€§ï¼Œæ¯”å¦‚**Promise**ã€**Generator**ã€**Symbol**ç­‰apiæ—¶ï¼ŒæŸäº›æµè§ˆå™¨æ ¹æœ¬ä¸è®¤è¯†è¿™äº›apiï¼Œå¹¶ä¸”ä½¿ç”¨**babel**ä¹Ÿæ²¡æœ‰ç”¨ï¼ˆå› ä¸ºbabelåªèƒ½å°†é«˜çº§è¯­æ³•è½¬åŒ–ä¸ºè¾ƒä¸ºä½ç‰ˆæœ¬çš„è¯­æ³•ï¼Œè€Œæ— æ³•ç»™ä½ åˆ›é€ apiï¼‰ã€‚è¿™æ˜¯å°±éœ€è¦polyfillç»™JavaScriptåŠ ä¸Šè¡¥ä¸

### å¦‚ä½•ä½¿ç”¨polyfill

```bash
npm i core-js regenerator-runtime
```

```jsx
// babel.config.js

module.exports = {
	presets: [
		["@babel/preset-env", {
			corejs: 3,
			useBuiltIns: false
		}]
	]
}
```

- corejsï¼šè®¾ç½®core-jsç‰ˆæœ¬
- useBuiltInsï¼šè®¾ç½®ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼ä½¿ç”¨polyfill
    - falseï¼šä¸ä½¿ç”¨polyfill
    - usageï¼šä½¿ç”¨polyfillï¼ˆå¿½ç•¥ç¬¬ä¸‰æ–¹åº“ï¼‰**âˆš**
    - entryï¼šä½¿ç”¨polyfillï¼ˆç¬¬ä¸‰æ–¹åº“å¦‚vueä¹Ÿå‚ä¸polyfillï¼‰ï¼Œéœ€è¦åœ¨ä¸»å…¥å£æ–‡ä»¶åŠ å…¥`import 'core-js/stabel'` å’Œ`import 'regenetator-runtime/runtime'`

## äº”ã€webpackæ­å»ºreactç¯å¢ƒ

- å®‰è£…`react`å’Œ`react-dom`
- å®‰è£…å¤„ç†jsxå¯¹åº”çš„babelæ’ä»¶
    - `@babel/plugin-systax-jsx`
    - `@babel/plugin-transform-react-jsx`
    - `@babel/plugin-transform-react-display-name`
- æˆ–è€…å®‰è£…å¯¹åº”çš„é¢„è®¾`@babel/preset-react`
- åˆ›å»ºæ‰“åŒ…çš„htmlæ¨¡æ¿

```bash
npm i react react-dom
npm i html-webpack-plugin -D
npm i @babel/plugin-systax-jsx @babel/plugin-transform-react-jsx @babel/plugin-transform-react-display-name -D
npm i @babel/preset-react -D
```

```jsx
// src/index.js
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './src/App.jsx'

ReactDOM.createRoot(document.getElementById('root')!).render(
    <React.StrictMode>
       <App />
    </React.StrictMode>
)
```

```jsx
// App.jsx
import { memo } from 'react'

const App = memo(() => {
    return <div>App</div>
})

export default App
```

```jsx
// webpack.config.js
import HtmlWebpackPlugin from 'html-webpack-plugin'
module.exports = {
	module: {
		rules: [
			{
				test: /\.jsx?$/,
				use: {
					loader: 'babel-loader'
				}
			}
		]
	},
	plugins: [
		new HtmlWebpackPlugin({
			template: './index.html'
		})
	]
}
```

## å…­ã€ç¼–è¯‘TypeScript

- ts-loader
- babel
    - `@babel/preset-typescript`
    - ä¼˜åŠ¿ï¼šå¯ä»¥é…ç½®polyfill
    - ç¼ºç‚¹ï¼šä¸ä¼šè¿›è¡Œç±»å‹æ£€æµ‹

```jsx
module.exports = {
	module: {
		rules: [
			{
				test: /\.ts?$/,
				exclude: /node_modules/
				use: {
					loader: 'ts-loader'
				}
			}
		]
	}
}
```

```jsx
// babel.config.js
module.exports = {
	presets: ["@babel/preset-env", "@babel/preset-env", "@babel/preset-typescript"]
}
```

### ä½¿ç”¨tscæ ¡éªŒç±»å‹

```json
{
	scripts: {
		"ts-check": "tsc --noEmits",
		"ts-check-watch": "tsc --noEmits --watch"
	}
}
```

## ä¸ƒã€webpackæœ¬åœ°æœåŠ¡å™¨

webpack-dev-serveråœ¨ç¼–è¯‘ä¹‹åä¸ä¼šå†™å…¥åˆ°ä»»ä½•è¾“å‡ºæ–‡ä»¶ï¼Œè€Œæ˜¯å°†bundleæ–‡ä»¶ä¿å­˜åœ¨**å†…å­˜**å½“ä¸­

### devServerå±æ€§

- staticï¼šé™æ€æ–‡ä»¶å­˜å‚¨ç›®å½•
    - é»˜è®¤ä¸º**public**
- liveReloadï¼šå½“ä»£ç ç¼–è¯‘å¤±è´¥æ—¶æ˜¯å¦é‡æ–°åˆ·æ–°æ•´ä¸ªé¡µé¢
    - é»˜è®¤ä¸ºfalseï¼Œä¼šåˆ·æ–°æ•´ä¸ªé¡µé¢
- portï¼šç›‘å¬çš„ç«¯å£å·
    - é»˜è®¤ä¸º8080
- compressï¼šå¯¹ä»£ç è¿›è¡Œå‹ç¼©
- proxyï¼šè§£å†³è·¨åŸŸé—®é¢˜
- changeOriginï¼šæ”¹å˜è¯·æ±‚å¤´çš„**host**
    - ä¸è®¾ç½®æ—¶ä¸ºé¡¹ç›®è¯·æ±‚åœ°å€ï¼Œè®¾ç½®ä¸ºtrueæ—¶ä¸ºæœåŠ¡å™¨çš„åœ°å€
- historyApiFallbackï¼šè§£å†³**SPAåº”ç”¨**åœ¨è·¯ç”±è·³è½¬ä¹‹åï¼Œè¿›è¡Œ**é¡µé¢åˆ·æ–°**æ—¶å‡ºç°**404é”™è¯¯**çš„é—®é¢˜

```jsx
// webpackæ–°å†™æ³•
module.exports = {
	devServer: {
		proxy: [
			{
				context: ['/api'],
				target: 'http://localhost:3000'
			}
		]
	}
}
// webpackæ—§å†™æ³•(å·²åºŸå¼ƒ)
module.exports = {
	devServer: {
		proxy: {
			'/api': {
				target: 'http://localhost:3000'
			}
		}
	}
}
```

<aside>
ğŸ’¡

ä»¥ä¸Šé…ç½®è¡¨ç¤ºå°†/apiå‰é¢çš„urlæ›¿æ¢ä¸ºtargetå±æ€§çš„åœ°å€ï¼Œå¦‚æœåç«¯è¯·æ±‚æ²¡æœ‰apiå‰ç¼€ï¼Œåˆ™éœ€è¦é…ç½®`pathRewrite:{'^/api': ''}`

</aside>

## å…«ã€webpackæ€§èƒ½ä¼˜åŒ–