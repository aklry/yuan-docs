---
description: ç†è§£webpackçš„é«˜çº§çŸ¥è¯†
categories:
  - webpack
---
# webpacké«˜çº§

## ä¸€ã€source-map

### ä½œç”¨

- èƒ½å¤Ÿä»å·²è½¬æ¢çš„ä»£ç ï¼Œæ˜ å°„åˆ°åŸå§‹çš„æºæ–‡ä»¶
- ä½¿æµè§ˆå™¨èƒ½å¤Ÿé‡æ„åŸå§‹æºå¹¶åœ¨è°ƒè¯•å…¶ä¸­æ˜¾ç¤ºé‡å»ºçš„åŸå§‹æº

å¦‚ä½•ä½¿ç”¨source-map

1. é€šè¿‡webpacké…ç½®ç”Ÿæˆsource-map
2. åœ¨è½¬æ¢åçš„ä»£ç ï¼Œæœ€åæ·»åŠ ä¸€ä¸ªæ³¨é‡Šï¼ŒæŒ‡å‘source-map(ä¾‹å¦‚ï¼š`// sourceMappingURL=common.bundle.js.map`)

### webpacké…ç½®

https://webpack.docschina.org/configuration/devtool/#devtool

```js
module.exports = {
	mode: 'production',
	devtool: 'source-map'
}
```

ä¸ä¼šç”Ÿæˆsource-mapæ–‡ä»¶çš„é…ç½®

- false
- noneï¼ˆproductionæ¨¡å¼ä¸‹çš„é»˜è®¤å€¼ï¼‰
- evalï¼ˆdevelopmentæ¨¡å¼ä¸‹çš„é»˜è®¤å€¼ï¼‰

ä¸å¸¸è§çš„source-mapé…ç½®

- eval-source-map(ä¸ç”Ÿæˆsource-mapæ–‡ä»¶ï¼Œä»¥`DataURL`çš„å½¢å¼æ”¾åœ¨`eval`å‡½æ•°åé¢)
- inline-source-map(ä¸ç”Ÿæˆsource-mapæ–‡ä»¶ï¼Œä»¥`DataURL`çš„å½¢å¼æ”¾åœ¨æ‰“åŒ…æ–‡ä»¶çš„åé¢)
- cheap-source-map(æ›´åŠ é«˜æ•ˆï¼Œä¸ä¼šæ˜ å°„åˆ—ä¿¡æ¯ï¼Œé…ç½®åœ¨development)
- cheap-module-source-map(ç±»ä¼¼äº**cheap-source-mapï¼Œ**æºè‡ªloaderçš„source-mapå¤„ç†ä¼šæ›´å¥½ï¼Œé…ç½®åœ¨development)
- hidden-source-map(ä¼šç”Ÿæˆsource-mapæ–‡ä»¶ï¼Œä½†åˆ é™¤çš„å¯¹åº”çš„å¼•ç”¨æ³¨é‡Šï¼Œéœ€è¦æ‰‹åŠ¨åŠ `//# sourceMappingURL=bundle.js.map`)
- nosources-source-map(ç”Ÿæˆçš„source-mapæ–‡ä»¶åªæœ‰é”™è¯¯ä¿¡æ¯ï¼Œä¸ä¼šç”Ÿæˆæºä»£ç )

## äºŒã€babel

### ä¸ºä»€ä¹ˆéœ€è¦babelï¼Ÿ

éƒ¨åˆ†æµè§ˆå™¨å¯èƒ½ä¸è®¤è¯†ES6+çš„è¯­æ³•ï¼Œä»¥åŠä¸è®¤è¯†vueã€reactã€typescriptä»£ç ï¼Œå› æ­¤éœ€è¦babelå°†è¿™äº›ä»£ç è½¬æ¢ä¸ºæµè§ˆå™¨è®¤è¯†çš„æ™®é€šçš„JavaScriptã€‚

### babelå‘½ä»¤è¡Œä½¿ç”¨

1. å®‰è£…`@babel/core` 
2. å®‰è£…`@babel/cli`
3. å®‰è£…æ’ä»¶(`@babel/plugin-transform-block-scoping`ã€`@babel/plugin-transform-arrow-function`)
4. æ‰§è¡Œå‘½ä»¤

```bash
npm i @babel/core @babel/cli -D
npx babel ./src --out-dir ./dist --plugins=@babel/plugin-transform-block-scoping,@babel/plugin-transform-arrow-function
```

### babelé¢„è®¾

è§£å†³æ¯ä¸€æ¬¡è½¬æ¢éƒ½éœ€è¦å®‰è£…ä¸€ç§æ’ä»¶çš„é—®é¢˜

```bash
npm install @babel/preset-env -D
npx babel ./src --out-dir ./dist --presets=@babel/preset-env
```

### babelçš„åº•å±‚åŸç†

babelæ˜¯ä¸€ç§**ç¼–è¯‘å™¨**ï¼Œå°†ä¸€ç§**æºä»£ç **è½¬æ¢ä¸ºå¦ä¸€ç§**æºä»£ç **

babelçš„å·¥ä½œæµç¨‹

- è§£æé˜¶æ®µï¼ˆParsingï¼‰
- è½¬æ¢é˜¶æ®µï¼ˆTransformationï¼‰
- ç”Ÿæˆé˜¶æ®µï¼ˆCode Generationï¼‰

![babelå·¥ä½œæµç¨‹](https://image.aklry.com/docs/babel.png)

### babelçš„é…ç½®æ–‡ä»¶

- `babel.config.json|js|mjs|cjs`
- `.babelrc.json|js|mjs|cjs` æˆ–è€…`.babelrc`

```js
module.exports = {
	presets: [
		["@babel/preset-env"]
	]
}
```

## ä¸‰ã€browserslistå·¥å…·

**browserslist**æ˜¯ä¸€ä¸ªåœ¨**ä¸åŒçš„å‰ç«¯å·¥å…·**ä¹‹é—´ï¼Œ**å…±äº«ç›®æ ‡æµè§ˆå™¨**å’Œ**Node.js**ç‰ˆæœ¬çš„é…ç½®

### æµè§ˆå™¨æŸ¥è¯¢è¿‡ç¨‹

æˆ‘ä»¬ä¼šç¼–å†™ç±»ä¼¼äºä¸‹é¢çš„é…ç½®ï¼š

```bash
> 1%
last 2 version
not dead
```

é‚£ä¹ˆä¹‹åï¼Œè¿™äº›å·¥å…·å¦‚**babel**ç­‰å°±ä¼šæ ¹æ®æˆ‘ä»¬çš„é…ç½®æ¥è·å–ç›¸å…³çš„æµè§ˆå™¨ä¿¡æ¯ï¼Œä»¥æ–¹ä¾¿å†³å®šæ˜¯å¦éœ€è¦è¿›è¡Œå…¼å®¹æ€§çš„æ”¯æŒã€‚

### browserslistç¼–å†™

- è§„åˆ™ä¸€
    - defaults: é»˜è®¤æµè§ˆå™¨é…ç½®(**>0.5%,last 2 version,FireFox ESR, not dead**)
    - 5%:é€šè¿‡å…¨å±€ä½¿ç”¨æƒ…å†µç»Ÿè®¡ä¿¡æ¯é€‰æ‹©çš„æµè§ˆå™¨ç‰ˆæœ¬ï¼Œ**è¡¨ç¤ºå¸‚åœºå æœ‰ç‡**ã€‚å¯ä»¥ä½¿ç”¨â‰¥ã€<ã€å’Œâ‰¤ä¿®é¥°ã€‚
    - dead:è¡¨ç¤º**24ä¸ªæœˆ**å†…æ²¡æœ‰å®˜æ–¹æ”¯æŒæˆ–è€…æ›´æ–°çš„æµè§ˆå™¨ã€‚
    - last 2 version: è¡¨ç¤ºæ¯ä¸ªæµè§ˆå™¨çš„**æœ€åä¸¤ä¸ª**ç‰ˆæœ¬
- è§„åˆ™äºŒ
    - node 10:é€‰æ‹©æœ€æ–°çš„Node.js 10.x.x
    - ios7: ç›´æ¥ä½¿ç”¨iosæµè§ˆå™¨ç‰ˆæœ¬7
    - not ieâ‰¤8:æ’é™¤å…ˆå‰æŸ¥è¯¢é€‰æ‹©çš„æµè§ˆå™¨
    
    ### é…ç½®browserslist
    
    - æ–¹æ¡ˆä¸€ï¼šåœ¨package.jsonæ–‡ä»¶é…ç½®
    - æ–¹æ¡ˆäºŒï¼š.browserslistrcæ–‡ä»¶
    
    ```json
    {
    	"browserslist": [
    		"last 2 version",
    		"not dead",
    		">0.2%"
    	]
    }
    ```
    
    ```bash
    >1%
    not dead
    last 2 version
    ```
    

### babelé…ç½®è¦†ç›–browserslist

```js
module.exports = {
	module: {
		rules: [
			{
				test: /\.js$/,
				use: [
					{
						loader: 'babel-loader',
						options: {
							presets: [
								["@babel/preset-env", {
									targets: ">5%"
								}]
							]
						}
					}
				]
			}
		]
	}
}
```

<aside>
ğŸ’¡

åœ¨å¼€å‘ä¸­ä¸ä¼šä½¿ç”¨**targets**å±æ€§ï¼Œè€Œæ˜¯ä½¿ç”¨browserslistå·¥å…·ï¼Œå› ä¸ºbrowserslistå·¥å…·å¯ä»¥åœ¨å¤šä¸ªå·¥å…·é—´**å…±äº«æµè§ˆå™¨å…¼å®¹æ€§**é…ç½®

</aside>

## å››ã€polyfill

### ä¸ºä»€ä¹ˆä½¿ç”¨polyfill

ä½†æˆ‘ä»¬ç”¨åˆ°ä¸€äº›æ–°çš„è¯­æ³•ç‰¹æ€§ï¼Œæ¯”å¦‚**Promise**ã€**Generator**ã€**Symbol**ç­‰apiæ—¶ï¼ŒæŸäº›æµè§ˆå™¨æ ¹æœ¬ä¸è®¤è¯†è¿™äº›apiï¼Œå¹¶ä¸”ä½¿ç”¨**babel**ä¹Ÿæ²¡æœ‰ç”¨ï¼ˆå› ä¸ºbabelåªèƒ½å°†é«˜çº§è¯­æ³•è½¬åŒ–ä¸ºè¾ƒä¸ºä½ç‰ˆæœ¬çš„è¯­æ³•ï¼Œè€Œæ— æ³•ç»™ä½ åˆ›é€ apiï¼‰ã€‚è¿™æ˜¯å°±éœ€è¦polyfillç»™JavaScriptåŠ ä¸Šè¡¥ä¸

### å¦‚ä½•ä½¿ç”¨polyfill

```bash
npm i core-js regenerator-runtime
```

```js
// babel.config.js

module.exports = {
	presets: [
		["@babel/preset-env", {
			corejs: 3,
			useBuiltIns: false
		}]
	]
}
```

- corejsï¼šè®¾ç½®core-jsç‰ˆæœ¬
- useBuiltInsï¼šè®¾ç½®ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼ä½¿ç”¨polyfill
    - falseï¼šä¸ä½¿ç”¨polyfill
    - usageï¼šä½¿ç”¨polyfillï¼ˆå¿½ç•¥ç¬¬ä¸‰æ–¹åº“ï¼‰**âˆš**
    - entryï¼šä½¿ç”¨polyfillï¼ˆç¬¬ä¸‰æ–¹åº“å¦‚vueä¹Ÿå‚ä¸polyfillï¼‰ï¼Œéœ€è¦åœ¨ä¸»å…¥å£æ–‡ä»¶åŠ å…¥`import 'core-js/stabel'` å’Œ`import 'regenetator-runtime/runtime'`

## äº”ã€webpackæ­å»ºreactç¯å¢ƒ

- å®‰è£…`react`å’Œ`react-dom`
- å®‰è£…å¤„ç†jsxå¯¹åº”çš„babelæ’ä»¶
    - `@babel/plugin-systax-js`
    - `@babel/plugin-transform-react-js`
    - `@babel/plugin-transform-react-display-name`
- æˆ–è€…å®‰è£…å¯¹åº”çš„é¢„è®¾`@babel/preset-react`
- åˆ›å»ºæ‰“åŒ…çš„htmlæ¨¡æ¿

```bash
npm i react react-dom
npm i html-webpack-plugin -D
npm i @babel/plugin-systax-js @babel/plugin-transform-react-js @babel/plugin-transform-react-display-name -D
npm i @babel/preset-react -D
```

```js
// src/index.js
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './src/App.js'

ReactDOM.createRoot(document.getElementById('root')!).render(
    <React.StrictMode>
       <App />
    </React.StrictMode>
)
```

```js
// App.js
import { memo } from 'react'

const App = memo(() => {
    return <div>App</div>
})

export default App
```

```js
// webpack.config.js
import HtmlWebpackPlugin from 'html-webpack-plugin'
module.exports = {
	module: {
		rules: [
			{
				test: /\.js?$/,
				use: {
					loader: 'babel-loader'
				}
			}
		]
	},
	plugins: [
		new HtmlWebpackPlugin({
			template: './index.html'
		})
	]
}
```

## å…­ã€ç¼–è¯‘TypeScript

- ts-loader
- babel
    - `@babel/preset-typescript`
    - ä¼˜åŠ¿ï¼šå¯ä»¥é…ç½®polyfill
    - ç¡®ç‚¹ï¼šä¸ä¼šè¿›è¡Œç±»å‹æ£€æµ‹

```js
module.exports = {
	module: {
		rules: [
			{
				test: /\.ts?$/,
				exclude: /node_modules/
				use: {
					loader: 'ts-loader'
				}
			}
		]
	}
}
```

```js
// babel.config.js
module.exports = {
	presets: ["@babel/preset-env", "@babel/preset-env", "@babel/preset-typescript"]
}
```

### ä½¿ç”¨tscæ ¡éªŒç±»å‹

```json
{
	scripts: {
		"ts-check": "tsc --noEmits",
		"ts-check-watch": "tsc --noEmits --watch"
	}
}
```

## ä¸ƒã€webpackæœ¬åœ°æœåŠ¡å™¨

webpack-dev-serveråœ¨ç¼–è¯‘ä¹‹åä¸ä¼šå†™å…¥åˆ°ä»»ä½•è¾“å‡ºæ–‡ä»¶ï¼Œè€Œæ˜¯å°†bundleæ–‡ä»¶ä¿å­˜åœ¨**å†…å­˜**å½“ä¸­

### devServerå±æ€§

- staticï¼šé™æ€æ–‡ä»¶å­˜å‚¨ç›®å½•
    - é»˜è®¤ä¸º**public**
- liveReloadï¼šå½“ä»£ç ç¼–è¯‘å¤±è´¥æ—¶æ˜¯å¦é‡æ–°åˆ·æ–°æ•´ä¸ªé¡µé¢
    - é»˜è®¤ä¸ºfalseï¼Œä¼šåˆ·æ–°æ•´ä¸ªé¡µé¢
- portï¼šç›‘å¬çš„ç«¯å£å·
    - é»˜è®¤ä¸º**8080**
- compressï¼šå¯¹ä»£ç è¿›è¡Œå‹ç¼©
- proxyï¼šè§£å†³è·¨åŸŸé—®é¢˜
- changeOriginï¼šæ”¹å˜è¯·æ±‚å¤´çš„**host**
    - ä¸è®¾ç½®æ—¶ä¸ºé¡¹ç›®è¯·æ±‚åœ°å€ï¼Œè®¾ç½®ä¸ºtrueæ—¶ä¸ºæœåŠ¡å™¨çš„åœ°å€
- historyApiFallbackï¼šè§£å†³**SPAåº”ç”¨**åœ¨è·¯ç”±è·³è½¬ä¹‹åï¼Œè¿›è¡Œ**é¡µé¢åˆ·æ–°**æ—¶å‡ºç°**404é”™è¯¯**çš„é—®é¢˜

```js
// webpackæ–°å†™æ³•
*module.exports = {
	devServer: {
		proxy: [
			{
				context: ['/api'],
				target: 'http://localhost:3000'
			}
		]
	}
}*
// webpackæ—§å†™æ³•(å·²åºŸå¼ƒ)
*module.exports = {
	devServer: {
		proxy: {
			'/api': {
				target: 'http://localhost:3000'
			}
		}
	}
}*
```

<aside>
ğŸ’¡

ä»¥ä¸Šé…ç½®è¡¨ç¤ºå°†/apiå‰é¢çš„urlæ›¿æ¢ä¸ºtargetå±æ€§çš„åœ°å€ï¼Œå¦‚æœåç«¯è¯·æ±‚æ²¡æœ‰apiå‰ç¼€ï¼Œåˆ™éœ€è¦é…ç½®`pathRewrite:{'^/api': ''}`

</aside>

## å…«ã€webpackæ€§èƒ½ä¼˜åŒ–

### ä»£ç åˆ†ç¦»

**ä¸ºä»€ä¹ˆè¦ä»£ç åˆ†ç¦»ï¼Ÿ**

ä¸åˆ†ç¦»å°†æ‰€æœ‰ä»£ç æ‰“åŒ…åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯¼è‡´æ–‡ä»¶ä½“ç§¯è¾ƒå¤§ï¼Œé¦–å±æ¸²æŸ“é€Ÿåº¦è¾ƒæ…¢ï¼Œç”¨æˆ·ä¼šé•¿æ—¶é—´çœ‹åˆ°ç©ºç™½é¡µé¢

**ä»£ç åˆ†ç¦»çš„æ–¹æ³•**

- å¤šå…¥å£
- åŠ¨æ€å¯¼å…¥
    - ECMAScriptä¸­çš„importè¯­æ³•
    - é­”æ³•æ³¨é‡Š
        - ç”¨äºä¿®æ”¹éå…¥å£æ–‡ä»¶æ‰“åŒ…åçš„**name**
- splitChunksè‡ªå®šä¹‰åˆ†åŒ…
    - chunksï¼šé»˜è®¤ä¸º**`async`**

```js
// webpack.config.js(å¤šå…¥å£)
module.exports = {
	// å¤šä¸ªäº§ç‰©
	entry: {
		index: './src/index.js',
		main: './src/main.js'
	},
	// å•äº§ç‰©
	// entry: ['./src/index.js', './src/main.js'],
}
// å…±äº«ä»£ç 
module.exports = {
	entry: {
		index: {
			import: './src/index.js',
			dependOn: 'shared'
		},
		main: {
			import: './src/main.js',
			dependOn: 'shared'
		},
		shared: ['axios']
	}
}
```

```js
// åŠ¨æ€å¯¼å…¥
const btn1 = document.createElement('button')
const btn2 = document.createElement('button')
btn1.textContent = 'Category'
btn2.textContent = 'About'

document.body.append(btn1)
document.body.append(btn2)

btn1.addEventListener('click', () => {
	import(/* webpackChunkName: "category" */ './router/category')
})

btn2.addEventListener('click', () => {
	import(/* webpackChunkName: "about" */ './router/about')
})
```

```js
// webpack.config.js
module.exports = {
	output: {
		// å•ç‹¬å¯¹åˆ†åŒ…çš„æ–‡ä»¶è¿›è¡Œå‘½å
		chunkFilename: '[name]_chunk.js'
	}
}
```

```js
module.exports = {
	// ä¼˜åŒ–é…ç½®
	optimization: {
		/* 
			è®¾ç½®ç”ŸæˆchunkIdçš„ç®—æ³•
	    - `named`
	    - `deterministic` â†’ ç¡®å®šæ€§çš„ï¼Œåœ¨ä¸åŒçš„ç¼–è¯‘ä¸­ä¸å˜çš„çŸ­æ•°å­—
	    - `natural` â†’ æŒ‰ç…§æ•°å­—çš„é¡ºåºä½¿ç”¨id
	        - ä¸åˆ©äºæµè§ˆå™¨ç¼“å­˜
		*/
		chunkIds: '',
		// æŠ½å–ä¸»å…¥å£æ–‡ä»¶çš„webpackè¿è¡Œæ—¶
		runtimeChunk: {
			name: 'runtime'
		},
		splitChunks: {
			chunks: 'all',
			// å½“ä¸€ä¸ªåŒ…å¤§äºæŒ‡å®šçš„å¤§å°æ—¶ï¼Œç»§ç»­æ‹†åŒ…
			// maxSize: 20000,
			// æ‹†åŒ…çš„æœ€å°å€¼
			minSize: 100,
			// è‡ªå®šä¹‰æ‹†åŒ…
			cacheGroups: {
				common: {
					test: /[\\/]common[\\/]/,
					name: 'common',
					reuseExistingChunk: true,
					priority: 10

				},
				vendor: {
					test: /[\\/]node_modules[\\/]/,
					name: 'vendor',
					reuseExistingChunk: true,
					enforce: true,
					priority: 20
				}
			}
		}
	}
}
```

### prefetchï¼ˆé¢„è·å–ï¼‰å’Œpreloadï¼ˆé¢„åŠ è½½ï¼‰

åœ¨å£°æ˜***import***æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼Œæ¥å‘ŠçŸ¥æµè§ˆå™¨

- prefetchï¼šå°†æ¥æŸäº›å¯¼èˆªä¸‹å¯èƒ½éœ€è¦çš„èµ„æº
- preloadï¼šå½“å‰å¯¼èˆªä¸‹å¯èƒ½éœ€è¦çš„èµ„æº

**åŒºåˆ«**

- ***preload***çš„chunkä¼šåœ¨çˆ¶chunkåŠ è½½æ—¶ï¼Œä»¥å¹¶è¡Œçš„æ–¹å¼å¼€å§‹åŠ è½½ã€‚***prefetch***çš„chunkä¼šåœ¨çˆ¶chunkåŠ è½½ç»“æŸåå¼€å§‹åŠ è½½
- ***preload***çš„chunkæœ‰ä¸­ç­‰ä¼˜å…ˆçº§ï¼Œå¹¶ç«‹å³ä¸‹è½½ã€‚***prefetch***çš„chunkåœ¨æµè§ˆå™¨é—²ç½®æ—¶ä¸‹è½½
- ***preload***çš„chunkä¼šåœ¨çˆ¶chunkä¸­ç«‹å³è¯·æ±‚ï¼Œç”¨äºå½“ä¸‹æ—¶åˆ»ã€‚***prefetch***çš„chunkä¼šç”¨äºæœªæ¥çš„æŸä¸ªæ—¶åˆ»

### CDN

**CDN**å«åš**å†…å®¹åˆ†å‘ç½‘ç»œ**ï¼Œæ˜¯æŒ‡ç›¸äº’è¿æ¥çš„ç½‘ç»œç³»ç»Ÿï¼Œåˆ©ç”¨**æœ€é è¿‘**æ¯ä¸ªç”¨æˆ·çš„æœåŠ¡å™¨ã€‚

CDNçš„ä¸¤ç§ç”¨æ³•

- æ‰“åŒ…æ‰€æœ‰é™æ€èµ„æºï¼Œæ”¾åˆ°CDNæœåŠ¡å™¨ â†’ æ”¹å˜`output.publicPath`
- ç¬¬ä¸‰æ–¹èµ„æºæ”¾åˆ°CDNæœåŠ¡å™¨

```js
// ç¬¬ä¸‰æ–¹èµ„æºæ”¾ç½®åˆ°CDNæœåŠ¡å™¨
module.exports = {
	externals: {
		dayjs: 'dayjs'
	}
}
```

<aside>
ğŸ’¡

externalsçš„keyå’Œvalue

- keyï¼šè¡¨ç¤ºè¦æ’é™¤çš„æ¡†æ¶çš„åç§°
- valueï¼šè¡¨ç¤ºè¦ä½¿ç”¨**CDN**çš„å€¼ï¼Œæ¯”å¦‚`JQuery`çš„$
</aside>

### shimmingé¢„æ”¯å…¨å±€å˜é‡

ç”¨äºç»™æˆ‘ä»¬çš„ä»£ç å¡«å……ä¸€äº›å«ç‰‡æ¥å¤„ç†é—®é¢˜ï¼Œæ¯”å¦‚ç°åœ¨ä¾èµ–ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œè¿™ä¸ªåº“æœ¬èº«ä¾èµ–`lodash`ï¼Œä½†æ˜¯é»˜è®¤æ²¡æœ‰å¯¹`lodash`è¿›è¡Œå¯¼å…¥ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡`ProvidePlugin`æ¥å®ç°shimmingæ•ˆæœ

```js
module.exports = {
	plugins: [
		new ProvidePlugin({
			dayjs: 'dayjs'
		})
	]
}
```

### æå–cssä»£ç 

```bash
npm i -D mini-css-extract-plugin
```

```js
const MiniCssExtractPlugin = require('mini-css-extract-plugin')

module.exports = {
	module: {
		rules: [
			{
				test: /\.css$/,
				use: [MiniCssExtractPlugin.loader, 'css-loader']
			}
		]
	}
}
```

### hashã€chunkhashã€contenthash

é€šè¿‡`MD4`çš„æ•£åˆ—å‡½æ•°å¤„ç†åï¼Œç”Ÿæˆä¸€ä¸ª128ä½çš„hashå€¼ï¼ˆ32ä¸ª16è¿›åˆ¶ï¼‰

- hashï¼šä¸é¡¹ç›®æœ‰å…³ï¼Œæ— è®ºé¡¹ç›®ä¸­çš„å“ªä¸ªæ–‡ä»¶å‘ç”Ÿæ”¹å˜ï¼Œéƒ½ä¼šå˜
- contenthashï¼šä¸åç§°æœ‰å…³ï¼Œå¯¹åº”åç§°çš„æ–‡ä»¶å†…å®¹å‘ç”Ÿæ”¹å˜ï¼Œä¸ä¼šå½±å“å¦å¤–æ–‡ä»¶çš„hashå€¼
- chunkhashï¼šåŒ…å«ä¸€ä¸ª**chunk**çš„æ‰€æœ‰å…ƒç´ ï¼Œæ— è®ºå“ªä¸ªæ¨¡å—å‘ç”Ÿæ”¹å˜éƒ½ä¼šå‘ç”Ÿæ”¹å˜

### JavaScriptå’ŒCSSçš„å‹ç¼©

- terserå·¥å…·

```bash
npm i terser -D
npx terser ./src/common/cache/index.js -o ./src/common/cache/cache.min.js -c arguments=true,arrows=true -m keep_classnames=false
```

- åœ¨webpackä¸­ä½¿ç”¨terser

```js
module.exports = {
	optimization: {
		minimize: true,
    minimizer: [
      new TerserPlugin({
        extractComments: false,
				terserOptions: {
					compress: {
						arguments: true,
						unused: true,
						drop_console: true
					},
					toplevel: false,
					mangle: true
				}
      }),
    ],
	}
}
```

- csså‹ç¼©

```bash
npm i css-minimizer-webpack-plugin -D
```

```js
module.exports = {
	optimization: {
		minimize: true,
    minimizer: [
      new TerserPlugin({
        extractComments: false,
				terserOptions: {
					compress: {
						arguments: true,
						unused: true,
						drop_console: true
					},
					toplevel: false,
					mangle: true
				}
      }),
      new CssMiniWebpackPlugin()
    ],
	}
}
```

### tree shaking

- **JavaScript**å®ç°**tree shaking**
    - useExports
        - å¯¼å…¥æ¨¡å—æ—¶åˆ†æå“ªäº›æ¨¡å—æœ‰è¢«ä½¿ç”¨
    - sideEffects
        - åœ¨`package.json`æ–‡ä»¶ä¸­é…ç½®

```json
{
	sideEffects: [
		"*.css"
	]
}
```

- **CSS**å®ç°**tree shaking**

```bash
npm i purgecss-webpack-plugin -D
```

```js
module.exports = {
	plugins: [
		new PurgeCSSPlugin({
			paths: glob.sync(path.resolve(process.cwd(), './src/**/*').replace(/\\/g, '/'), { nodir: true })
		})
	]
}
```

<aside>
ğŸ’¡

å¯¹äº**css modules**æ— æ•ˆ

</aside>

### scope hosting(ä½œç”¨åŸŸæå‡)

å°†å¤šä¸ªæ¨¡å—çš„ä»£ç å°½é‡æ”¾åˆ°åŒä¸€ä¸ªæ¨¡å—ï¼Œç§°ä¹‹ä¸º**ä½œç”¨åŸŸæå‡**

```js
module.exports = {
	plugins: [
		new webpack.optimize.ModuleConcatenationPlugin()
	]
}
```

### HTTPå‹ç¼©

æµç¨‹

1. HTTPæ•°æ®åœ¨æœåŠ¡å™¨å‘é€å‰å·²ç»å‹ç¼©ï¼ˆåœ¨webpackå®Œæˆï¼‰
2. æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œå‘ŠçŸ¥æœåŠ¡å™¨è‡ªå·±æ”¯æŒå“ªäº›å‹ç¼©æ ¼å¼
3. æœåŠ¡å™¨ç›´æ¥è¿”å›è¢«å‹ç¼©åçš„æ–‡ä»¶ï¼Œå¹¶åœ¨å“åº”å¤´ä¸­å‘ŠçŸ¥æµè§ˆå™¨

![æµç¨‹2](https://image.aklry.com/docs/accept-encoding.png)

æµç¨‹2

![æµç¨‹3](https://image.aklry.com/docs/content-encoding.png)

æµç¨‹3

### HTMLå‹ç¼©

åˆ©ç”¨`html-webpack-plugin`æ’ä»¶

```js
module.exports = (isProduction) => {
	return {
		plugins: [
			new HtmlWebpackPlugin({
					template: './index.html',
					cache: true,
					minify: isProduction
						? {
								// ç§»é™¤æ³¨é‡Š
								removeComments: true,
								// ç§»é™¤ç©ºå±æ€§
								removeEmptyAttributes: true,
								// ç§»é™¤å†—ä½™å±æ€§
								removeRedundantAttributes: true,
								// æŠ˜å ç©ºç™½
								collapseWhitespace: true,
								// å‹ç¼©å†…è”css
								minifyCSS: true
						  }
						: false
				})
		]
	}
}
```

### æ‰“åŒ…æ—¶é—´åˆ†æ

```bash
npm i speed-mesaure-webpack-plugin -D
```

```js
const SpeedMeasurePlugin = require('speed-measure-webpack-plugin')

const smp = new SpeedMeasurePlugin()
// webpacké…ç½®
const config = {}

module.exports = smp.wrap(config)
```

<aside>
ğŸ’¡

æ³¨æ„ï¼šè¯¥æ’ä»¶ä¸`mini-css-extract-plugin` ä¸å…¼å®¹

</aside>

### æ‰“åŒ…æ–‡ä»¶åˆ†æ

- æ–¹æ¡ˆä¸€ï¼šæ‰“åŒ…æ—¶ç”Ÿæˆ`stats.json`æ–‡ä»¶

```json
{
	"scripts": {
		"build": "webpack --config ./config/webpack.prod.js --env production --profile --json=stats.json",
	}
}
```

<aside>
ğŸ’¡

å°†ç”Ÿæˆåçš„`stats.json`æ–‡ä»¶ä¸Šä¼ [https://webpack.github.io/analyse/](https://webpack.github.io/analyse/)è¿›è¡Œåˆ†æ

</aside>

- æ–¹æ¡ˆäºŒï¼š`webpack-bundle-analyzer`
    - æ‰“åŒ…æ—¶ä¼šè‡ªåŠ¨æ‰“å¼€127.0.0.1:8888

```bash
npm i webpack-bundle-analyzer -D
```

```js
const { BundleAnalyzerPlugin } = require('webpack-bundle-analyzer')
module.exports = {
	plugins: [
		new BundleAnalyzerPlugin ()
	]
}
```

![webpack-analyze](https://image.aklry.com/docs/webpack-analyze.png)

## ä¹ã€è‡ªå®šä¹‰loader

- loaderçš„æœ¬è´¨æ˜¯ä¸€ä¸ª**å¯¼å‡ºä¸ºå‡½æ•°çš„JavaScriptæ¨¡å—**
- è¯¥å‡½æ•°æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š
    - source: æºä»£ç 
    - mapï¼šsource mapç›¸å…³æ•°æ®
    - metaï¼šä¸€äº›å…ƒæ•°æ®

### ä»€ä¹ˆæ˜¯åŒæ­¥çš„loaderå’Œå¼‚æ­¥çš„loaderï¼Ÿ

- é»˜è®¤åˆ›å»ºçš„loaderå°±æ˜¯åŒæ­¥çš„loader
- è¿™ä¸ªloaderå¿…é¡»é€šè¿‡`return`æˆ–è€…`this.callback`æ¥è¿”å›ç»“æœï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªloaderå¤„ç†
- é€šå¸¸åœ¨æœ‰é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œä¼šä½¿ç”¨`this.callback`
- callback
    - parameters 1ï¼šè¡¨ç¤ºé”™è¯¯ä¿¡æ¯
    - parameters 2ï¼šè¡¨ç¤ºè¦å‘ä¸Šä¸€ä¸ªloaderä¼ é€’çš„å†…å®¹
- asyncï¼šå¼‚æ­¥çš„loader

```js
module.exports = function(source) {
	return source.replace(/console\.log\(.+\);?/g, '')
	// æˆ–è€…
	const callback = this.callback
	callback(null, source.replace(/console\.log\(.+\);?/g, ''))
}
```

```js
module.exports = function(source) {
	// æˆ–è€…
	const async = this.async()
	setTimeout(() => {
		async(null, source.replace(/console\.log\(.+\);?/g, ''))
	}, 2000)
}
```

### loaderä¼ å‚

- ä½¿ç”¨`loader-utils`
- ä½¿ç”¨`this.getOptions`

```js
const jsLoader = function (source) {
	const callback = this.callback
	const options = this.getOptions()
	const { name, age } = options
	console.log(`name: ${name}, age: ${age}`)
	callback(null, source.replace(/console\.log\(.+\);?/g, ''))
}

module.exports = jsLoader
```

### loaderå‚æ•°æ ¡éªŒ

```bash
npm i schema-utils -D
```

```json
{
	"type": "object",
	"properties": {
		"name": {
			"type": "string"
		},
		"age": {
			"type": "number"
		}
	}
}
```

```js
const { validate } = require('schema-utils')
const schema = require('./schema.json')
const jsLoader = function (source) {
	const callback = this.callback
	const options = this.getOptions()
	const { name, age } = options
	validate(schema, options)
	callback(null, source.replace(/console\.log\(.+\);?/g, ''))
}

module.exports = jsLoader
```

### å®ç°md-loader

```js
const { Marked } = require('marked')
const highlightJs = require('highlight.js')
const { markedHighlight } = require('marked-highlight')
const mdLoader = function (source) {
	const marked = new Marked(
		markedHighlight({
			emptyLangClass: 'hljs',
			langPrefix: 'hljs language-',
			highlight(code, lang) {
				const language = highlightJs.getLanguage(lang) ? lang : 'plaintext'
				return highlightJs.highlight(code, { language }).value
			}
		})
	)
	const htmlContent = marked.parse(source)
	// è¿”å›çš„ç»“æœå¿…é¡»æ˜¯æ¨¡å—åŒ–å†…å®¹
	const innerContent = '`' + htmlContent + '`'
	const moduleContent = `var code = ${innerContent};\nexport default code`
	return moduleContent
}

module.exports = mdLoader
```

## åã€è‡ªå®šä¹‰plugin

### tapable

![](https://image.aklry.com/docs/tapable%E7%9A%84hook.jpg)

**åŒæ­¥å’Œå¼‚æ­¥**

- **sync**
- **async**

**å…¶ä»–ç±»åˆ«**

- **bail**ï¼šæœ‰è¿”å›å€¼æ—¶ï¼Œä¸ä¼šæ‰§è¡Œåç»­çš„æ“ä½œ
- **loop**ï¼šå½“è¿”å›å€¼ä¸º**true**æ—¶ï¼Œå°±ä¼šåå¤æ‰§è¡Œï¼Œè¿”å›å€¼ä¸º**undefined**æˆ–è€…ä¸è¿”å›å€¼æ—¶ï¼Œå°±é€€å‡ºäº‹ä»¶
- **waterfall**ï¼šå½“è¿”å›å€¼ä¸ä¸º**undefined**æ—¶ï¼Œä¼šå°†æ­¤æ¬¡è¿”å›çš„ç»“æœä½œä¸ºä¸‹æ¬¡äº‹ä»¶çš„**ç¬¬ä¸€ä¸ª**å‚æ•°
- **parallel**ï¼šå¹¶è¡Œï¼Œä¸ä¼šç­‰åˆ°ä¸Šä¸€ä¸ªæ‰§è¡Œäº‹ä»¶å›è°ƒæ‰§è¡Œç»“æŸï¼Œæ‰æ‰§è¡Œä¸‹ä¸€æ¬¡äº‹ä»¶å¤„ç†å›è°ƒ
- **series**ï¼šä¸²è¡Œï¼Œä¼šç­‰å¾…ä¸Šä¸€æ¬¡å¼‚æ­¥çš„hook

<aside>
ğŸ’¡

ä»¥ä¸Šä¸¤ç»„ï¼Œå¯ä»¥äº’ç›¸ç»„åˆ

</aside>

**webpackå¦‚ä½•æ³¨å†Œplugin**

1. åœ¨webpackå‡½æ•°çš„`createCompiler`æ–¹æ³•ä¸­æ³¨å†Œäº†æ‰€æœ‰æ’ä»¶
2. åœ¨æ³¨å†Œæ’ä»¶æ—¶ï¼Œä¼šè°ƒç”¨æ’ä»¶å‡½æ•°æˆ–è€…æ’ä»¶å¯¹è±¡çš„applyæ–¹æ³•
3. æ’ä»¶æ–¹æ³•ä¼šæ¥æ”¶compilerå¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡compilerå¯¹è±¡æ¥æ³¨å†Œhookçš„äº‹ä»¶
4. æŸäº›æ’ä»¶ä¹Ÿä¼šæ’å…¥ä¸€ä¸ªcompilationçš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ç›‘å¬compilationçš„hookäº‹ä»¶

### å®ç°`AutoUploadAssetsWebpackPlugin`

```js
const { Compiler } = require('webpack')
const { NodeSSH } = require('node-ssh')
const fs = require('fs')
const path = require('path')
const archiver = require('archiver')
class AutoUploadAssetsPlugin {
	constructor(config) {
		this.config = config || {}
	}
	/**
	 * @param { Compiler } compiler
	 */
	apply(compiler) {
		compiler.hooks.afterEmit.tapAsync('AutoUploadAssetsPlugin', async (compilation, callback) => {
			console.log('Assets have been emitted, starting upload process...')
			// 1. è·å–è¾“å‡ºæ–‡ä»¶å¤¹
			const outputPath = compilation.outputOptions.path
			// 2. å‹ç¼©è¾“å‡ºæ–‡ä»¶å¤¹
			const localFile = path.resolve(process.cwd(), this.config.targetFile)
			await this.compressFile(outputPath, localFile)
			// 3. è¿æ¥è¿œç¨‹æœåŠ¡å™¨
			const sshClient = await this.connectToServer()
			// 4. åˆ é™¤è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„æ—§æ–‡ä»¶
			await this.runCommander(sshClient, `rm -rf ${this.config.releaseDir}`, this.config.deployDir)
			// 5. ä¸Šä¼ æ–°æ–‡ä»¶
			await this.uploadFile(sshClient, this.config, localFile)
			// 6. è§£å‹ç¼©è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶
			await this.runCommander(sshClient, `unzip ${this.config.releaseDir}`, this.config.deployDir)
			// 7. åˆ é™¤è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„å‹ç¼©åŒ…
			await this.runCommander(sshClient, `rm -rf ${this.config.releaseDir}`, this.config.deployDir)
			// 8. é‡å‘½å
			await this.runCommander(sshClient, `mv dist ${this.config.releaseDir}`, this.config.deployDir)
			// 9. æ–­å¼€è¿æ¥
			sshClient.dispose()
			callback()
		})
	}
	connectToServer() {
		const sshClient = new NodeSSH()
		return new Promise(resolve => {
			sshClient.connect(this.config.ssh).then(() => {
				console.log('Connected to server successfully')
				resolve(sshClient)
			})
		})
	}

	runCommander(ssh, command, path) {
		return new Promise(resolve => {
			ssh.execCommand(command, { cwd: path }).then(result => {
				resolve()
			})
		})
	}

	compressFile(targetDir, localFile) {
		return new Promise(resolve => {
			// åˆ›å»ºå¯å†™æµ
			const output = fs.createWriteStream(localFile)
			const archive = archiver('zip', {
				zlib: { level: 9 }
			})
			archive.pipe(output)
			archive.directory(targetDir, 'dist')
			archive.finalize()

			archive.on('close', () => {
				console.log((archive.pointer() / 1024 / 1024).toFixed(2), 'MB')
				resolve()
			})
		})
	}

	uploadFile(ssh, config, local) {
		return new Promise(resolve => {
			ssh.putFile(local, this.config.deployDir + config.releaseDir)
				.then(() => {
					console.log('upload success')
					resolve()
				})
				.catch(err => {
					console.log(err)
				})
		})
	}
}

module.exports = AutoUploadAssetsPlugin
module.exports.AutoUploadAssetsPlugin = AutoUploadAssetsPlugin
```