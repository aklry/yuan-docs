# webpackåŸºæœ¬ä½¿ç”¨

## ä¸€ã€webpackåŸºæœ¬æ¦‚å¿µ

webpackæ˜¯ä¸ºç°ä»£çš„JavaScriptåº”ç”¨è€Œç”Ÿçš„é™æ€çš„æ¨¡å—æ‰“åŒ…å™¨

å¦‚å›¾ï¼Œwebpackå¯ä»¥å°†å„ç§èµ„æºæ‰“åŒ…æˆæœ€åŸºæœ¬çš„é™æ€èµ„æº(jsã€cssã€html)

![](https://image.aklry.com/docs/webpack.png)

## äºŒã€webpackçš„ä¸¤ç§ä½¿ç”¨æ–¹å¼

### 2.1 nodeæ–¹å¼

```jsx
const webpack = require('webpack')
// config è¡¨ç¤ºwebpackçš„é…ç½®
webpack(config, (err, stats) => {})
```

```json
{
	"scripts": {
		"build": "node ./build.js"
	}
}
```

### 2.2 å‘½ä»¤è¡Œæ–¹å¼

```bash
npm i webpack webpack-cli -D
```

```json
{
	"scripts": {
		"build": "webpack"
	}
}
```

## ä¸‰ã€webpacké…ç½®æ–‡ä»¶

```jsx
module.exports = {
		// é¡¹ç›®å…¥å£
		entry: '',
		output: {
			path: '',
			filename: ''
		},
}
```

<aside>
ğŸ’¡

- `entry`ä¸ºæ•°ç»„æ—¶è¡¨ç¤ºå¤šå…¥å£
- `output.path`è¡¨ç¤ºè¾“å‡ºçš„ç›®å½•ï¼Œå¿…é¡»ä¸ºç»å¯¹è·¯å¾„
- `output.filename`è¡¨ç¤ºè¾“å‡ºçš„äº§ç‰©åç§°
</aside>

<aside>
ğŸ’¡

é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨`webpack-cli`ä¸å†™é…ç½®æ–‡ä»¶æ—¶ï¼Œ**webpack**é»˜è®¤ä¼šæŸ¥æ‰¾å½“å‰ç›®å½•ä¸­`src/index.js`ä½œä¸ºå…¥å£ï¼Œå› æ­¤è‹¥æ²¡æœ‰`index.js`æ–‡ä»¶ï¼Œåˆ™ä¼šæŠ¥can not resolve â€œ./srcâ€é”™è¯¯ã€‚é™¤æ­¤ä»¥å¤–ï¼Œå¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–è€…ä¸æƒ³ç”¨ä½¿ç”¨é»˜è®¤çš„`webpack.config.js`ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨å‘½ä»¤è¡Œçš„æ–¹å¼ä¸ºwebpackæŒ‡å®šå…¥å£ä»¥åŠæŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œå¦‚

```bash
npx webpack --entry ./src/index.js
npx webpack --config webpack.dev.js
```

</aside>

## å››ã€webpackæ‰“åŒ…

### 4.1 webpackçš„æ‰“åŒ…æµç¨‹

1. æ ¹æ®å‘½ä»¤è¡Œæˆ–è€…é…ç½®æ–‡ä»¶æ‰¾åˆ°å…¥å£æ–‡ä»¶
2. ä»å…¥å£å¼€å§‹ï¼Œé€æ­¥å½¢æˆ**ä¾èµ–å…³ç³»å›¾**ï¼Œ**ä¾èµ–å…³ç³»å›¾**åŒ…å«JavaScriptåº”ç”¨ç¨‹åºçš„æ‰€æœ‰æ¨¡å—ï¼ˆæ¯”å¦‚JavaScriptæ–‡ä»¶ï¼Œcssæ–‡ä»¶ã€å›¾ç‰‡ã€å­—ä½“ç­‰ï¼‰
3. éå†**ä¾èµ–å…³ç³»å›¾**ï¼Œæ‰“åŒ…ä¸€ä¸ªä¸ªæ¨¡å—ï¼ˆæ ¹æ®ä¸åŒçš„æ–‡ä»¶ä½¿ç”¨ä¸åŒçš„**loader**æ¥è§£æï¼‰

### 4.2 loaderçš„ä½œç”¨

webpacké»˜è®¤æ”¯æŒè§£æjsæ–‡ä»¶ä»¥åŠjsonæ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¼å…¥jsæˆ–è€…jsonæ–‡ä»¶ï¼Œä½†æ˜¯å½“æˆ‘ä»¬ç›´æ¥å¯¼å…¥é™¤è¿™ä¸¤ç§æ ¼å¼ä»¥å¤–çš„æ–‡ä»¶ç±»å‹è¿›è¡Œæ‰“åŒ…æ—¶ï¼Œwebpackä¼šæŠ¥ä»¥ä¸‹é”™è¯¯ï¼š

**module parse fail in â€˜./srcâ€™,you need an appropriate loader to handle this file type.**

è¿™å°±æ˜¯loaderçš„ä½œç”¨ï¼Œå®ƒå¯ä»¥åŠ å¼ºwebpackå¯¹å…¶ä»–æ–‡ä»¶çš„æ”¯æŒ

### 4.3 é…ç½®loader

```jsx
module.exports = {
		module: {
				rules: [
						{
								test: /\.css$/,
								loader: 'css-loader'
						}
				]
		}
}
```

<aside>
ğŸ’¡

åœ¨webpacké…ç½®æ–‡ä»¶ä¸­æ·»åŠ `module.rules` å±æ€§ï¼Œè¯¥å±æ€§çš„å€¼æ˜¯ä¸€ä¸ª`Array<object>` ï¼Œæ¯ä¸€ä¸ªå¯¹è±¡è¡¨ç¤ºä¸€ç§æ–‡ä»¶ç±»å‹ã€‚

**å¯¹è±¡çš„å±æ€§ï¼š**

1. testï¼šåŒ¹é…å¯¹åº”çš„æ–‡ä»¶ï¼ˆä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼‰
2. useï¼šå½“éœ€è¦å¤šä¸ªloaderå¤„ç†åŒä¸€ç§æ–‡ä»¶ç±»å‹æ—¶ä½¿ç”¨ï¼Œè¯¥å±æ€§çš„å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„å€¼å¯ä»¥æ˜¯å…·ä½“çš„loaderç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡
    1. loaderï¼šä½¿ç”¨çš„loader
    2. optionsï¼šè¯¥loaderçš„é…ç½®
3. includeï¼šè¯¥loaderéœ€è¦å¤„ç†çš„ç›®å½•
4. excludeï¼šè¯¥loaderä¸éœ€è¦å¤„ç†çš„ç›®å½•

**loaderçš„åŠ è½½é¡ºåºï¼š**

ä»å³å‘å·¦æˆ–ä»ä¸‹åˆ°ä¸Š

</aside>

### 4.4 å¸¸ç”¨çš„loader

- å¤„ç†cssçš„loader
    - style-loaderï¼ˆå°†csså¤„ç†ä¸ºé¡µé¢styleæ ·å¼ï¼‰
    - css-loaderï¼ˆè§£æcssï¼‰
    - postcss-loader
        - autoprefixerï¼ˆè‡ªåŠ¨æ·»åŠ æµè§ˆå™¨å‰ç¼€ï¼‰
        - postcss-preset-envï¼ˆå°†ç°ä»£åŒ–çš„cssç‰¹æ€§è½¬ä¸ºæµè§ˆå™¨è®¤è¯†çš„ï¼ŒåŒ…æ‹¬æ·»åŠ å‰ç¼€ï¼‰
- å¤„ç†æ–‡ä»¶

webpack5å¯ä»¥ç›´æ¥ä½¿ç”¨èµ„æºæ¨¡å—ç±»å‹æ¥ä»£æ›¿loaderï¼Œåªéœ€è¦åœ¨`module.rules` ä¸­æ·»åŠ å¯¹åº”çš„è§„åˆ™

```jsx
module.exports = {
		module: {
				rules: [
						{
								test: /\.(png|jpe?g|webp|svg|gif)$/,
								type: 'asset'
						}
				]
		}
}
```

<aside>
ğŸ’¡

èµ„æºæ¨¡å—ç±»å‹:

- asset/resource(å‘é€ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¹¶å¯¼å‡ºURL) â†’ file-loader
    - æ‰“åŒ…åç”Ÿæˆå›¾ç‰‡ï¼Œæœ‰urlä¸ä¹‹å¯¹åº”
    - ç¼ºç‚¹
        - æœ‰é¢å¤–çš„ç½‘ç»œè¯·æ±‚
- asset/inline(å¯¼å‡ºä¸€ä¸ªèµ„æºçš„ data URI) â†’ url-loader
    - å°†å›¾ç‰‡è¿›è¡Œbase64ç¼–å·ï¼Œå¹¶å°†ç¼–ç åçš„æºç æ”¾åˆ°æ‰“åŒ…åçš„jsæ–‡ä»¶ä¸­
    - ç¼ºç‚¹
        - jsæ–‡ä»¶åŠ è½½æ—¶é—´è¿‡é•¿
- asset/source(å¯¼å‡ºèµ„æºçš„æºä»£ç ) â†’ row-loader
- asset(åœ¨å¯¼å‡ºä¸€ä¸ªURIå’Œå•ç‹¬çš„æ–‡ä»¶ä¹‹é—´è‡ªåŠ¨é€‰æ‹©) â†’ url-loader
    - å¯¹äºå°å›¾ç‰‡é‡‡å–ç”Ÿæˆbase64
    - å¯¹äºå¤§å›¾ç‰‡ç”Ÿæˆç‹¬ç«‹çš„å›¾ç‰‡
    - é…ç½®
        - parser
        - generator
            - filename(ç”Ÿæˆçš„æ–‡ä»¶å,ä½¿ç”¨å ä½ç¬¦`img/[name]_[hash:8][ext]`)
</aside>

- å¤„ç†.jsæ–‡ä»¶
    - babel-loader
        - `@babel/plugin-transform-arrow-functions`
        - `@babel/plugin-transform-block-scoping`
        - `@babel/preset-env`
- å¤„ç†.vueæ–‡ä»¶
    - vue-loader
        - VueLoaderPlugin(æ’ä»¶ï¼Œå¿…é¡»ä½¿ç”¨)

### 4.5 resolveæ¨¡å—è§£æ

1. ç¡®å®šæ–‡ä»¶è¿˜æ˜¯æ–‡ä»¶å¤¹
- å¦‚æœæ˜¯ä¸€ä¸ªæ–‡ä»¶
    - æ–‡ä»¶å…·æœ‰æ‰©å±•åï¼Œåˆ™ç›´æ¥æ‰“åŒ…æ–‡ä»¶
    - å¦åˆ™ï¼Œä½¿ç”¨`resolve.extensions`é€‰é¡¹ä½œä¸ºæ–‡ä»¶æ‰©å±•åè§£æ
- å¦‚æœæ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹
    - ä¼šåœ¨æ–‡ä»¶å¤¹ä¸­æ ¹æ®`resolve.mainFiles`é…ç½®é€‰é¡¹ä¸­çš„æ–‡ä»¶é¡ºåºæŸ¥æ‰¾
        - `resolve.mainFiles`çš„é»˜è®¤å€¼æ˜¯`['index']`
        - å†æ ¹æ®`resolve.extensions`æ¥è§£ææ‰©å±•å

`resolve.extensions` é»˜è®¤å€¼`['.wasm', '.js', '.mjs', '.json']`

1. aliasé…ç½®åˆ«å

```jsx
module.exports = {
	resolve: {
		alias: {
			utils: path.resolve(__dirname, './src/utils')		
		}
	}
}
```

### 4.6 plugin

loaderä¸pluginçš„åŒºåˆ«

- loaderç”¨äºç‰¹å®šæ¨¡å—ç±»å‹çš„è½¬æ¢
- pluginå¯ä»¥ç”¨äºæ‰§è¡Œæ›´å¹¿æ³›çš„ä»»åŠ¡ï¼Œæ¯”å¦‚æ‰“åŒ…ä¼˜åŒ–ã€èµ„æºç®¡ç†ã€ç¯å¢ƒå˜é‡æ³¨å…¥

### 4.7 å¸¸ç”¨çš„plugin

```jsx
module.exports = {
	plugins: [
		// æ‰“åŒ…å‰å…ˆæ¸…é™¤æ‰æ‰€æœ‰æ‰“åŒ…æ–‡ä»¶
		new CleanWebpackPlugin(),
		// è‡ªåŠ¨ç”Ÿæˆæ¨¡æ¿html
		new HtmlWebpackPlugin({
			// æŒ‡å®štitle
			title: 'webpack',
			// æŒ‡å®šæ¨¡æ¿
			template: 'æ¨¡æ¿è·¯å¾„'
		}),
		new webpack.DefinePlugin({
			"BASE_URL": "'./'"
		})
	]
}
```

- `CleanWebpackPlugin`
    - å¯ä½¿ç”¨[`output.clean`](https://webpack.docschina.org/configuration/output/#outputclean)ä»£æ›¿
- `HtmlWebpackPlugin`
- `DefinePlugin`

### 4.8 modeé…ç½®

| é€‰é¡¹ | æè¿° |
| --- | --- |
| development | ä¼šå°†`DefinePlugin`ä¸­`process.env.NODE_ENV`çš„å€¼è®¾ä¸ºdevelopmentï¼Œä¸ºæ¨¡å—å’Œchunkå¯ç”¨æœ‰æ•ˆçš„å |
| production | ä¼šå°†`DefinePlugin`ä¸­`process.env.NODE_ENV`çš„å€¼è®¾ä¸ºproductionï¼Œä¸ºæ¨¡å—å’Œchunkå¯ç”¨ç¡®å®šæ€§çš„æ··æ·†å |
| none | ä¸ä½¿ç”¨ä»»ä½•é»˜è®¤ä¼˜åŒ–é€‰é¡¹ |

## äº”ã€webpackå¼€å¯æœ¬åœ°æœåŠ¡å™¨

1. `npm i webpack-dev-server -D` 
2. åœ¨`package.json`çš„scriptsæ·»åŠ ä¸€è¡Œå‘½ä»¤`"serve:webpack serve"` 

<aside>
ğŸ’¡

webpack-dev-serveråœ¨æ‰“åŒ…ä¹‹åä¸ä¼šå°†æ–‡ä»¶å†™å…¥ç£ç›˜ï¼Œè€Œæ˜¯ä¿å­˜åœ¨å†…å­˜ï¼Œå› ä¸ºç£ç›˜çš„è¯»å†™æ•ˆç‡å¤ªä½äº†

</aside>

## å…­ã€HMR(æ¨¡å—çƒ­æ›¿æ¢)

ä»€ä¹ˆæ˜¯**HMR**

- å…¨ç¨‹**Hot Module Replace**
- æŒ‡åœ¨åº”ç”¨ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œ**æ›¿æ¢**ã€**æ·»åŠ **ã€**åˆ é™¤**æ¨¡å—ï¼Œè€Œæ— éœ€é‡æ–°åˆ·æ–°æ•´ä¸ªé¡µé¢

å¼€å¯**HMR**

å°†`devServer.hot`è®¾ç½®ä¸ºtrueï¼Œä½†æ˜¯ä»ç„¶ä¼šé‡æ–°åˆ·æ–°æ•´ä¸ªé¡µé¢ï¼Œå› ä¸ºéœ€è¦æŒ‡å®šå“ªä¸€ä¸ªæ¨¡å—éœ€è¦**HMR**

```jsx
if (module.hot) {
	module.hot.accept("./utils/math.js")
}
```

**devServer**é…ç½®

```jsx
module.exports = {
	devServer: {
		hot: true,
		port: 8888,
		host: "0.0.0.0",
		open: true,
		compress: true
	}
}
```

<aside>
ğŸ’¡

`0.0.0.0` è¡¨ç¤ºç›‘å¬IPV4ä¸Šæ‰€æœ‰çš„åœ°å€ï¼Œå†æ ¹æ®ç«¯å£æ‰¾åˆ°ä¸åŒçš„åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚å½“æˆ‘ä»¬ç›‘å¬`0.0.0.0`æ—¶ï¼Œåœ¨åŒä¸€ä¸ªç½‘æ®µä¸‹çš„ä¸»æœºï¼Œé€šè¿‡ipåœ°å€æ˜¯å¯ä»¥è®¿é—®çš„ã€‚

openè®¾ç½®ä¸ºtrueè¡¨ç¤ºç¼–è¯‘å®Œæˆåç«‹å³æ‰“å¼€æµè§ˆå™¨

compressè¡¨ç¤ºæ˜¯å¦å¯¹æ–‡ä»¶è¿›è¡Œå‹ç¼©

</aside>

## ä¸ƒã€å¦‚ä½•åŒºåˆ†å¼€å‘ç¯å¢ƒ

1. åˆ›å»ºä»£è¡¨ä¸åŒç¯å¢ƒçš„æ–‡ä»¶
    1. `webpack.dev.js`
    2. `webpack.prod.js`
2. æ ¹æ®ä¸åŒé…ç½®æ–‡ä»¶ç¼–å†™ä¸åŒçš„æ‰§è¡Œè„šæœ¬

```json
{
	scripts: {
		"dev": "webpack --config webpack.dev.js",
		"prod": "webpack --config webpack.prod.js"
	}
}
```

1. ç¼–å†™ä¸åŒç¯å¢ƒçš„é…ç½®
    1. æŠ½å–å…¬å…±é…ç½®`webpack.base.js` 
        1. `npm i webpack-merge -D`

```jsx
const { merge } = require('webpack-merge')
const baseConfig = require('./config.base')
const devConfig = require('./config.dev')

module.exports = merge(baseConfig, devConfig)
```